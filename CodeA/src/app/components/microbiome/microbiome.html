<div class="step-container" style="text-align:left; padding: 30px;">

  <!-- ── STEP 1: Disease Selection + Upload ───────────────────────────── -->
  @if (!uploadDone) {
    <h2 class="main-title" style="text-align:center;">Microbiome Dataset Upload</h2>
    <p class="subtitle" style="text-align:center;">Select a disease type and upload the corresponding CSV dataset</p>

    <!-- Disease type cards -->
    <div class="disease-type-grid">
      @for (d of diseases; track d.value) {
        <div
          class="signal-type-card"
          [class.disease-card--active]="selectedDisease === d.value"
          (click)="selectDisease(d.value)"
        >
          <div class="card-icon">
            <svg width="52" height="52" viewBox="0 0 100 100" fill="none"
                 stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              @if (d.value === 'Diarrhea') {
                <circle cx="50" cy="50" r="20"/>
                <circle cx="30" cy="35" r="8"/>
                <circle cx="70" cy="35" r="6"/>
                <circle cx="30" cy="65" r="5"/>
                <circle cx="65" cy="68" r="9"/>
                <path d="M 50 30 Q 55 20 65 28"/>
                <path d="M 30 43 Q 25 50 30 57"/>
              }
              @if (d.value === 'Hydrocephalus') {
                <path d="M 30,25 C 25,20 20,25 20,30 C 20,35 18,40 20,45 C 18,50 20,55 25,58 C 25,65 30,70 35,72 L 50,75 L 65,72 C 70,70 75,65 75,58 C 80,55 82,50 80,45 C 82,40 80,35 80,30 C 80,25 75,20 70,25"/>
                <path d="M 35,30 C 40,28 45,32 45,35"/>
                <path d="M 55,35 C 55,32 60,28 65,30"/>
                <path d="M 38,60 C 42,58 45,60 48,62"/>
                <path d="M 52,62 C 55,60 58,58 62,60"/>
                <path d="M 50,25 L 50,72"/>
              }
              @if (d.value === 'Diabetes') {
                <circle cx="50" cy="40" r="18"/>
                <path d="M 42 40 L 58 40 M 50 32 L 50 48"/>
                <path d="M 30 65 Q 50 55 70 65"/>
                <circle cx="30" cy="70" r="7"/>
                <circle cx="70" cy="70" r="7"/>
                <path d="M 23 70 L 37 70 M 30 63 L 30 77"/>
              }
            </svg>
          </div>
          <h3>{{ d.label }}</h3>
          <p>{{ d.description }}</p>
        </div>
      }
    </div>

    <!-- Upload zone -->
    <div class="control-panel" style="margin-top: 30px;">
      <label class="control-label">Upload Dataset (CSV)</label>

      <div class="custom-file-upload">
        <input
          #fileInput
          type="file"
          class="file-input-hidden"
          accept=".csv"
          (change)="onFileSelected($event)"
        />
        <label class="file-upload-label" (click)="fileInput.click()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span class="file-text">
            {{ selectedFile ? selectedFile.name : 'Click to choose a .csv file' }}
          </span>
        </label>
        <div class="help-text">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          Only .csv files are accepted
        </div>
      </div>
    </div>

    <!-- Upload button + messages -->
    <div style="text-align:center; margin-top: 24px;">
      <button
        class="back-btn"
        style="background: linear-gradient(90deg, #1e3c72, #2a5298);"
        [disabled]="!selectedDisease || !selectedFile || uploading"
        (click)="uploadDataset()"
      >
        @if (!uploading) { Upload Dataset }
        @else {
          <span class="upload-dots">
            <span></span><span></span><span></span>
          </span>
        }
      </button>

      @if (uploadError) {
        <div class="status-msg status-msg--error" style="margin-top:16px;">
          ✖ {{ uploadError }}
        </div>
      }
    </div>
  }

  <!-- ── STEP 2: Query Participant ────────────────────────────────────── -->
  @if (uploadDone && !result) {
    <div style="margin-bottom: 20px;">
      <button class="back-btn" (click)="resetUpload()">&#8592; Upload a Different Dataset</button>
    </div>

    <div class="status-msg status-msg--success" style="margin-bottom: 24px;">
      ✔ Dataset uploaded for <strong>{{ selectedDisease }}</strong> — ready to query participants
    </div>

    <div class="control-panel">
      <label class="control-label">Participant Index</label>
      <div style="display:flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-top: 10px;">
        <input
          type="number"
          class="channel-select"
          min="0"
          placeholder="e.g. 0, 1, 2 …"
          [(ngModel)]="participantIndex"
          style="min-width: 200px; font-size: 1rem; padding: 12px 18px;"
        />
        <button
          class="back-btn"
          style="background: linear-gradient(90deg, #1e3c72, #2a5298); margin-bottom:0;"
          [disabled]="participantIndex === null || fetching"
          (click)="fetchParticipant()"
        >
          @if (!fetching) { Analyze Patient }
          @else {
            <span class="upload-dots">
              <span></span><span></span><span></span>
            </span>
          }
        </button>
      </div>

      @if (fetchError) {
        <div class="status-msg status-msg--error" style="margin-top: 14px;">
          ✖ {{ fetchError }}
        </div>
      }
    </div>
  }

  <!-- ── STEP 3: Results ───────────────────────────────────────────────── -->
  @if (result) {
    <div style="margin-bottom: 20px; display:flex; gap:12px; flex-wrap:wrap;">
      <button class="back-btn" (click)="resetToQuery()">&#8592; Query Another Participant</button>
      <button class="back-btn" (click)="resetUpload()" style="background: linear-gradient(90deg, #5a7ba6, #7e8ba3);">
        ⬆ Change Dataset
      </button>
    </div>

    <h2 class="main-title">
      Patient Report —
      <span style="color: #4a90e2;">{{ result.participantID.trim() }}</span>
    </h2>
    <p class="subtitle" style="margin-bottom: 28px;">
      {{ selectedDisease }} microbiome analysis &bull; Index {{ participantIndex }}
    </p>

    <!-- KPI cards -->
    <div class="kpi-grid">
      <div class="kpi-card kpi-card--good">
        <div class="kpi-card__value">{{ result.GoodBacteriaSum | number:'1.0-1' }}</div>
        <div class="kpi-card__label">Good Bacteria</div>
      </div>
      <div class="kpi-card kpi-card--bad">
        <div class="kpi-card__value">{{ result.BadBacteriaSum | number:'1.0-1' }}</div>
        <div class="kpi-card__label">Bad Bacteria</div>
      </div>
      <div class="kpi-card" [ngClass]="getDICardClass(result.DI)">
        <div class="kpi-card__value">{{ result.DI | number:'1.3-4' }}</div>
        <div class="kpi-card__label">Dysbiosis Index</div>
        <div class="kpi-card__sub">{{ getDILabel(result.DI) }}</div>
      </div>
      <div class="kpi-card" [class.kpi-card--disease]="result.HasDisease" [class.kpi-card--healthy]="!result.HasDisease">
        <div class="kpi-card__value" style="font-size:2.2rem;">
          {{ result.HasDisease ? '⚠' : '✔' }}
        </div>
        <div class="kpi-card__label">{{ result.HasDisease ? 'Disease Positive' : 'No Disease Detected' }}</div>
      </div>
    </div>

    <!-- Bar chart -->
    <div class="channel-selection-panel" style="margin-top: 24px;">
      <h5 class="section-title">Bacterial Abundance Profile</h5>

      <div class="chart-legend">
        <span class="legend-chip legend-chip--good">● Good Bacteria</span>
        <span class="legend-chip legend-chip--bad">● Bad Bacteria</span>
        <span class="legend-chip legend-chip--zero">● Not Detected</span>
      </div>

      <div class="bacteria-chart">
        @for (b of bacteriaEntries; track b.name) {
          <div class="bar-row">
            <div class="bar-row__label" [title]="b.name">{{ b.name }}</div>
            <div class="bar-row__track">
              <div
                class="bar-row__fill"
                [class.bar-row__fill--good]="b.isGood && b.value > 0"
                [class.bar-row__fill--bad]="!b.isGood && b.value > 0"
                [style.width.%]="getBarWidth(b.value)"
              ></div>
            </div>
            <div class="bar-row__value">{{ b.value | number:'1.0-1' }}</div>
          </div>
        }
      </div>
    </div>
  }

</div>