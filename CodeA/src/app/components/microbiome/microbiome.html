<div class="step-container" style="text-align:left; padding: 30px;">

  <!-- STEP 1: Upload -->
  @if (!uploadDone) {
    <h2 class="main-title" style="text-align:center;">Microbiome Dataset Upload</h2>
    <p class="subtitle" style="text-align:center;">Upload your metadata and taxonomy files to begin analysis</p>

    <div class="control-panel" style="margin-top: 30px;">

      <!-- Metadata File -->
      <label class="control-label">Metadata File (.csv)</label>
      <div class="custom-file-upload">
        <input #metaInput type="file" class="file-input-hidden" accept=".csv"
               (change)="onMetadataFileSelected($event)"/>
        <label class="file-upload-label" (click)="metaInput.click()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span class="file-text">{{ metadataFile ? metadataFile.name : 'Click to choose metadata .csv' }}</span>
        </label>
      </div>

      <!-- Taxonomy File -->
      <label class="control-label" style="margin-top: 20px;">Taxonomy File (.gz)</label>
      <div class="custom-file-upload">
        <input #taxInput type="file" class="file-input-hidden" accept=".gz"
               (change)="onTaxonomyFileSelected($event)"/>
        <label class="file-upload-label" (click)="taxInput.click()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span class="file-text">{{ taxonomyFile ? taxonomyFile.name : 'Click to choose taxonomy .gz' }}</span>
        </label>
      </div>

      <div class="help-text" style="margin-top: 10px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Both files are required to proceed
      </div>
    </div>

    <div style="text-align:center; margin-top: 24px;">
      <button class="back-btn"
              style="background: linear-gradient(90deg, #1e3c72, #2a5298);"
              [disabled]="!metadataFile || !taxonomyFile || uploading"
              (click)="uploadDataset()">
        @if (!uploading) { Upload Dataset }
        @else {
          <span class="upload-dots"><span></span><span></span><span></span></span>
        }
      </button>

      @if (uploadError) {
        <div class="status-msg status-msg--error" style="margin-top:16px;">✖ {{ uploadError }}</div>
      }
    </div>
  }

  <!-- STEP 2: Query Participant -->
  @if (uploadDone && !result) {
    <div style="margin-bottom: 20px;">
      <button class="back-btn" (click)="resetUpload()">&#8592; Upload Different Files</button>
    </div>

    <div class="status-msg status-msg--success" style="margin-bottom: 24px;">
      ✔ Dataset uploaded successfully — enter a participant index to begin analysis
    </div>

    <div class="control-panel">
      <label class="control-label">Participant Index</label>
      <div style="display:flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-top: 10px;">
      <select class="custom-select large" [(ngModel)]="participantIndex">
        <option [value]="null" disabled>-- Select a Participant --</option>
        @for (p of participants; track p.id; let i = $index) {
          <option [value]="i">
            {{ p.id }} — {{ p.diagnosis }}
          </option>
        }
      </select>
        <button class="back-btn"
                style="background: linear-gradient(90deg, #1e3c72, #2a5298); margin-bottom:0;"
                [disabled]="participantIndex === null || fetching"
                (click)="fetchParticipant()">
          @if (!fetching) { Analyze Participant }
          @else {
            <span class="upload-dots"><span></span><span></span><span></span></span>
          }
        </button>
      </div>

      @if (fetchError) {
        <div class="status-msg status-msg--error" style="margin-top: 14px;">✖ {{ fetchError }}</div>
      }
    </div>
  }

  <!-- STEP 3: Results -->
  @if (result) {
    <div style="margin-bottom: 20px; display:flex; gap:12px; flex-wrap:wrap;">
      <button class="back-btn" (click)="resetToQuery()">&#8592; Query Another Participant</button>
      <button class="back-btn" (click)="resetUpload()"
              style="background: linear-gradient(90deg, #5a7ba6, #7e8ba3);">
        ⬆ Change Dataset
      </button>
    </div>

    <h2 class="main-title">
      Patient Report — <span style="color: #4a90e2;">{{ result.participant_id }}</span>
    </h2>
    <p class="subtitle" style="margin-bottom: 28px;">
      Diagnosis: <strong>{{ result.diagnosis }}</strong> &bull; Index {{ participantIndex }}
    </p>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card" [ngClass]="getDICardClass(result.Average_Dysbiosis_Index)">
        <div class="kpi-card__value">{{ result.Average_Dysbiosis_Index | number:'1.2-3' }}</div>
        <div class="kpi-card__label">Avg Dysbiosis Index</div>
        <div class="kpi-card__sub">{{ getDILabel(result.Average_Dysbiosis_Index) }}</div>
      </div>
      <div class="kpi-card kpi-card--good">
        <div class="kpi-card__value">{{ result.Good_Bacteria.length }}</div>
        <div class="kpi-card__label">Good Bacteria Types</div>
      </div>
      <div class="kpi-card kpi-card--bad">
        <div class="kpi-card__value">{{ result.Bad_Bacteria.length }}</div>
        <div class="kpi-card__label">Bad Bacteria Types</div>
      </div>
    </div>

    @if (dysbiosisConfig) {
      <div class="channel-selection-panel" style="margin-top: 24px;">
        <h5 class="section-title">Dysbiosis Index Over Time</h5>
        <app-signal-graph [config]="dysbiosisConfig" xAxisLabel="Week" graphId="dysbiosis-graph"></app-signal-graph>
      </div>
    }

    @if (goodBacteriaConfig) {
      <div class="channel-selection-panel" style="margin-top: 24px;">
        <h5 class="section-title" style="color: #155724;">Good Bacteria Over Time</h5>
        <app-signal-graph [config]="goodBacteriaConfig" xAxisLabel="Week" graphId="good-bacteria-graph"></app-signal-graph>
      </div>
    }

    @if (badBacteriaConfig) {
      <div class="channel-selection-panel" style="margin-top: 24px;">
        <h5 class="section-title" style="color: #721c24;">Bad Bacteria Over Time</h5>
        <app-signal-graph [config]="badBacteriaConfig" xAxisLabel="Week" graphId="bad-bacteria-graph"></app-signal-graph>
      </div>
    }

  }
</div>