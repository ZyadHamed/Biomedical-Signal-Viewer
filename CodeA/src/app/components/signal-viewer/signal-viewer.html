<div class="app-header">
  <div class="header-content">
    <div class="header-logo">
      <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M3 12h3l2-8 4 16 2-8h3" />
        <circle cx="18" cy="12" r="2" fill="white" />
      </svg>
    </div>
    <div>
      <h1 class="header-title">Signal Viewer</h1>
      <p class="header-subtitle">ECG & EEG Biomedical Signal Analysis</p>
    </div>
  </div>
</div>

<div class="container">

  @if (step === 1) {
  <div class="step-container">
    <h2 class="main-title">Select Signal Type</h2>
    <p class="subtitle">Choose the type of biomedical signal you want to analyze</p>

    <div class="signal-type-grid">
      <div class="signal-type-card" (click)="selectSignalType('ecg')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 60" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M 5,30 L 15,30 L 18,28 L 21,30 L 25,30 L 28,15 L 31,45 L 34,25 L 37,32 L 42,30 L 50,30 L 53,28 L 56,30 L 60,30 L 63,15 L 66,45 L 69,25 L 72,32 L 77,30 L 95,30" />
          </svg>
        </div>
        <h3>ECG Analysis</h3>
        <p>Electrocardiogram • Heart Signals</p>
      </div>

      <div class="signal-type-card" (click)="selectSignalType('eeg')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M 30,25 C 25,20 20,25 20,30 C 20,35 18,40 20,45 C 18,50 20,55 25,58 C 25,65 30,70 35,72 L 50,75 L 65,72 C 70,70 75,65 75,58 C 80,55 82,50 80,45 C 82,40 80,35 80,30 C 80,25 75,20 70,25" />
            <path d="M 35,30 C 40,28 45,32 45,35" />
            <path d="M 55,35 C 55,32 60,28 65,30" />
            <path d="M 32,45 C 37,43 40,47 42,50" />
            <path d="M 58,50 C 60,47 63,43 68,45" />
            <path d="M 38,60 C 42,58 45,60 48,62" />
            <path d="M 52,62 C 55,60 58,58 62,60" />
            <path d="M 50,25 L 50,72" />
          </svg>
        </div>
        <h3>EEG Signals</h3>
        <p>Electroencephalogram • Brain Activity</p>
      </div>
    </div>
  </div>
  }

  @if (step === 2) {
  <div class="step-container">
    <button class="back-btn" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Back
    </button>

    <h2 class="main-title">Select Channel Mode</h2>
    <p class="subtitle">{{ signalType.toUpperCase() }} Analysis • Choose your display mode</p>

    <div class="channel-mode-grid">
      <div class="channel-mode-card" (click)="selectChannelMode('single')">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <path d="M3 9h18M3 15h18" />
            <path d="M9 3v18" />
          </svg>
        </div>
        <h3>Single Channel</h3>
        <p>View one channel at a time</p>
      </div>

      <div class="channel-mode-card" (click)="selectChannelMode('multi')">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2">
            <path d="M3 3h18v6H3zM3 10h18v4H3zM3 15h18v6H3z" />
            <path d="M3 12h18" />
          </svg>
        </div>
        <h3>Multi-Channel</h3>
        <p>Vertically stacked channels</p>
      </div>
    </div>
  </div>
  }

  @if (step === 3) {
  <div>
    <button class="back-btn" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Back to Mode Selection
    </button>

    <div class="text-center mb-4">
      <h2 class="main-title">{{ signalType.toUpperCase() }} Signal Viewer</h2>
      <p class="subtitle">{{ channelMode === 'single' ? 'Single Channel' : 'Multi-Channel' }} Display Mode</p>
    </div>

    <div class="control-panel">
      <div class="mb-3">
        <label class="control-label">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          Upload Signal File
        </label>

        <div class="custom-file-upload">
          <input type="file"
                 class="file-input-hidden"
                 (change)="onFileSelect($event)"
                 accept=".json"
                 id="fileInput"
                 #fileInput>
          <label for="fileInput" class="file-upload-label">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" />
              <polyline points="13 2 13 9 20 9" />
            </svg>
            <span class="file-text">{{ fileInput.files && fileInput.files.length > 0 ? fileInput.files[0].name : 'Choose JSON File' }}</span>
          </label>
        </div>
        <small class="help-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 16v-4M12 8h.01" />
          </svg>
          Select a converted JSON file from your ECG/EEG data
        </small>
      </div>
    </div>

    @if (channels.length > 0) {
    <div>
      <div class="control-panel text-center mb-3">
        <h5 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
          </svg>
          Select Visualization Mode
        </h5>
        <div class="visualization-mode-grid">
          <button type="button"
                  class="viz-mode-btn"
                  [class.active]="displayMode === 'time'"
                  (click)="setDisplayMode('time')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
            </svg>
            <span>Time Domain</span>
          </button>
          <button type="button"
                  class="viz-mode-btn"
                  [class.active]="displayMode === 'reoccurrence'"
                  (click)="setDisplayMode('reoccurrence')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <line x1="3" y1="9" x2="21" y2="9" />
              <line x1="9" y1="21" x2="9" y2="9" />
            </svg>
            <span>Reoccurrence Map</span>
          </button>
          <button type="button"
                  class="viz-mode-btn"
                  [class.active]="displayMode === 'polar'"
                  (click)="setDisplayMode('polar')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <circle cx="12" cy="12" r="6" />
              <circle cx="12" cy="12" r="2" />
            </svg>
            <span>Polar Graph</span>
          </button>
          <button type="button"
                  class="viz-mode-btn"
                  [class.active]="displayMode === 'xor'"
                  (click)="setDisplayMode('xor')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            </svg>
            <span>XOR Graph</span>
          </button>
        </div>
      </div>

      <div class="channel-selection-panel">

        @if (displayMode === 'reoccurrence') {
        <h5 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Select Channels & Color Map
        </h5>
        <div class="row justify-content-center">
          <div class="col-md-4">
            <div class="select-group">
              <label class="select-label">X-Axis Channel</label>
              <select class="custom-select" (change)="onReoccurrenceChannelChange('x', $event)" [value]="reoccurrenceChX">
                @for (channel of channels; track $index) {
                <option [value]="$index">{{ channel }}</option>
                }
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="select-group">
              <label class="select-label">Y-Axis Channel</label>
              <select class="custom-select" (change)="onReoccurrenceChannelChange('y', $event)" [value]="reoccurrenceChY">
                @for (channel of channels; track $index) {
                <option [value]="$index">{{ channel }}</option>
                }
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="select-group">
              <label class="select-label">Color Map</label>
              <select class="custom-select" [(ngModel)]="reoccurrenceColorMap" (change)="plotSignals()">
                @for (cmap of colorMapOptions; track $index) {
                <option [value]="cmap">{{ cmap }}</option>
                }
              </select>
            </div>
          </div>
        </div>
        }

        @if (displayMode === 'polar') {
        <h5 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <circle cx="12" cy="12" r="10" />
          </svg>
          Polar Graph Display Mode
        </h5>
        <div class="text-center mb-4">
          <div class="polar-mode-toggle">
            <button type="button"
                    class="polar-toggle-btn"
                    [class.active]="polarMode === 'fixed'"
                    (click)="polarMode = 'fixed'; plotSignals()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              Latest Fixed Time
            </button>
            <button type="button"
                    class="polar-toggle-btn"
                    [class.active]="polarMode === 'cumulative'"
                    (click)="polarMode = 'cumulative'; plotSignals()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
              </svg>
              Cumulative Plot
            </button>
          </div>
        </div>
        }

        @if (displayMode === 'time' || displayMode === 'polar' || displayMode === 'xor') {
        <h5 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M3 3v18h18" />
            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
          </svg>
          Select Channels to Display
        </h5>

        @if (channelMode === 'multi') {
        <div class="channel-grid">
          @for (channel of channels; track $index) {
          <label class="channel-checkbox-card">
            <input type="checkbox"
                   class="channelBox"
                   [checked]="selectedChannels[$index]"
                   (change)="onChannelToggle($index)">
            <span class="channel-checkmark">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            </span>
            <span class="channel-name">{{ channel }}</span>
          </label>
          }
        </div>
        }

        @if (channelMode === 'single') {
        <div class="single-channel-selector">
          <select class="custom-select large" (change)="onSingleChannelChange($event)">
            <option value="" disabled selected>-- Select a Channel --</option>
            @for (channel of channels; track $index) {
            <option [value]="$index">{{ channel }}</option>
            }
          </select>
        </div>
        }
        }

        @if (displayMode === 'reoccurrence' || hasSelectedChannels()) {
        <div class="playback-controls">
          <div class="playback-buttons">
            <button class="control-btn pause-btn" (click)="pause()" [disabled]="isPaused" title="Pause Playback">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16" />
                <rect x="14" y="4" width="4" height="16" />
              </svg>
            </button>
            <button class="control-btn play-btn" (click)="resume()" [disabled]="!isPaused" title="Resume Playback">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3" />
              </svg>
            </button>

            <div class="speed-control">
              <label class="speed-label">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                </svg>
                Speed
              </label>
              <select class="custom-select speed-select" (change)="setPlaybackSpeed($event)" [value]="playbackSpeed">
                <option value="0.5">0.5×</option>
                <option value="1">1×</option>
                <option value="2">2×</option>
                <option value="5">5×</option>
              </select>
            </div>
          </div>

          <div class="time-control">
            <label class="control-label">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              Time Window: <span class="time-value-inline">{{ timeWindowSeconds.toFixed(1) }}s</span>
            </label>
            <div class="slider-wrapper">
              <input type="range"
                     class="time-slider"
                     [min]="1"
                     [max]="getMaxTimeWindow()"
                     [step]="0.1"
                     [value]="timeWindowSeconds"
                     (input)="onTimeWindowChange($event)"
                     id="timeScale">
              <div class="slider-track"></div>
            </div>
          </div>
        </div>
        }

        <div class="graph-container">
          @if (channels.length === 0) {
          <div class="empty-state">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" />
              <polyline points="13 2 13 9 20 9" />
            </svg>
            <p class="empty-title">No Signal Loaded</p>
            <p class="empty-subtitle">Upload a JSON file to begin analysis</p>
          </div>
          }

          @if (channels.length > 0 && displayMode === 'time' && !hasSelectedChannels()) {
          <div class="empty-state">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="1.5" opacity="0.5">
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <p class="empty-title success">Signal Loaded Successfully</p>
            <p class="empty-subtitle">Select channels above to display waveforms</p>
          </div>
          }

          <div id="signal-graph" class="signal-graph"></div>
        </div>
      </div>
    </div>
    }
  </div>
  }

</div>
