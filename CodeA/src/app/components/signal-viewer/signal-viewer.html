<!-- Professional Header -->
<div class="app-header">
  <div class="header-content">
    <div class="header-logo">
      <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M3 12h3l2-8 4 16 2-8h3"/>
        <circle cx="18" cy="12" r="2" fill="white"/>
      </svg>
    </div>
    <div>
      <h1 class="header-title">Signal Viewer</h1>
      <p class="header-subtitle">ECG, EEG &amp; Doppler Signal Analysis</p>
    </div>
  </div>
</div>

<div class="container">

  <!-- STEP 1: Choose Signal Type -->
  @if (step === 1) {
  <div class="step-container">
    <h2 class="main-title">Select Signal Type</h2>
    <p class="subtitle">Choose the type of signal you want to analyze</p>

    <div class="signal-type-grid-four">

      <!-- ECG -->
      <div class="signal-type-card" (click)="selectSignalType('ecg')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 60" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M 5,30 L 15,30 L 18,28 L 21,30 L 25,30 L 28,15 L 31,45 L 34,25 L 37,32 L 42,30 L 50,30 L 53,28 L 56,30 L 60,30 L 63,15 L 66,45 L 69,25 L 72,32 L 77,30 L 95,30"/>
          </svg>
        </div>
        <h3>ECG Analysis</h3>
        <p>Electrocardiogram • Heart Signals</p>
      </div>

      <!-- EEG -->
      <div class="signal-type-card" (click)="selectSignalType('eeg')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M 30,25 C 25,20 20,25 20,30 C 20,35 18,40 20,45 C 18,50 20,55 25,58 C 25,65 30,70 35,72 L 50,75 L 65,72 C 70,70 75,65 75,58 C 80,55 82,50 80,45 C 82,40 80,35 80,30 C 80,25 75,20 70,25"/>
            <path d="M 35,30 C 40,28 45,32 45,35"/>
            <path d="M 55,35 C 55,32 60,28 65,30"/>
            <path d="M 32,45 C 37,43 40,47 42,50"/>
            <path d="M 58,50 C 60,47 63,43 68,45"/>
            <path d="M 38,60 C 42,58 45,60 48,62"/>
            <path d="M 52,62 C 55,60 58,58 62,60"/>
            <path d="M 50,25 L 50,72"/>
          </svg>
        </div>
        <h3>EEG Signals</h3>
        <p>Electroencephalogram • Brain Activity</p>
      </div>

      <!-- Doppler -->
      <div class="signal-type-card" (click)="selectSignalType('doppler')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
            <rect x="20" y="50" width="60" height="25" rx="5"/>
            <circle cx="35" cy="75" r="8"/>
            <circle cx="65" cy="75" r="8"/>
            <path d="M 10,35 Q 10,50 10,65" opacity="0.7"/>
            <path d="M 5,28 Q 5,50 5,72" opacity="0.5"/>
            <path d="M 90,35 Q 90,50 90,65" opacity="0.7"/>
            <path d="M 95,28 Q 95,50 95,72" opacity="0.5"/>
          </svg>
        </div>
        <h3>Vehicle-Passing Doppler</h3>
        <p>Acoustic Signals • Velocity Estimation</p>
      </div>
      
      <div class="signal-type-card" (click)="selectSignalType('drone')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <!-- Arms -->
            <line x1="50" y1="50" x2="22" y2="22"/>
            <line x1="50" y1="50" x2="78" y2="22"/>
            <line x1="50" y1="50" x2="22" y2="78"/>
            <line x1="50" y1="50" x2="78" y2="78"/>

            <!-- Rotors -->
            <circle cx="22" cy="22" r="11"/>
            <circle cx="78" cy="22" r="11"/>
            <circle cx="22" cy="78" r="11"/>
            <circle cx="78" cy="78" r="11"/>

            <!-- Rotor spin lines -->
            <line x1="12" y1="22" x2="32" y2="22" opacity="0.6"/>
            <line x1="68" y1="22" x2="88" y2="22" opacity="0.6"/>
            <line x1="12" y1="78" x2="32" y2="78" opacity="0.6"/>
            <line x1="68" y1="78" x2="88" y2="78" opacity="0.6"/>

            <!-- Body -->
            <rect x="38" y="38" width="24" height="24" rx="6"/>

            <!-- Camera dot -->
            <circle cx="50" cy="50" r="4" fill="white" opacity="0.6"/>
          </svg>
        </div>
        <h3>Drone Detector</h3>
        <p>Validate whether an uploaded audio file is a drone sound or not</p>
      </div>

      <!-- Microbiome -->
      <div class="signal-type-card" (click)="selectSignalType('microbiome')">
        <div class="card-icon">
          <svg width="90" height="90" viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="50" cy="50" r="44" opacity="0.4"/>
            <circle cx="50" cy="50" r="38" opacity="0.2"/>

            <rect x="40" y="40" width="30" height="12" rx="6" transform="rotate(-45 55 46)" />
            
            <path d="M 38 60 Q 30 65 35 75" opacity="0.8"/>
            <path d="M 43 65 Q 40 75 48 80" opacity="0.6"/>

            <circle cx="30" cy="35" r="5" />
            <circle cx="42" cy="28" r="4" opacity="0.9"/>
            <circle cx="32" cy="23" r="3" opacity="0.7"/>

            <path d="M 65 30 Q 70 22 75 30 T 85 30" opacity="0.9"/>
            
            <rect x="65" y="65" width="16" height="8" rx="4" transform="rotate(20 73 69)" opacity="0.8"/>
          </svg>
        </div>
        <h3>Microbiome Data</h3>
        <p>Bacterium Count Visualization • Patient Profile Estimation</p>
      </div>


    </div>
  </div>
  }

  <!-- STEP 2: Choose Channel Mode (ECG/EEG only) -->
  @if (step === 2 && (signalType === 'ecg' || signalType === 'eeg')) {
  <div class="step-container">
    <button class="back-btn" (click)="goBack()">&#8592; Back</button>

    <h2 class="main-title">Select Channel Mode</h2>
    <p class="subtitle">{{ signalType.toUpperCase() }} Analysis &bull; Choose your display mode</p>

    <div class="channel-mode-grid">
      <div class="channel-mode-card" (click)="selectChannelMode('single')">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M3 9h18M3 15h18"/>
            <path d="M9 3v18"/>
          </svg>
        </div>
        <h3>Single Channel</h3>
        <p>View one channel at a time</p>
      </div>

      <div class="channel-mode-card" (click)="selectChannelMode('multi')">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2">
            <rect x="3" y="3" width="18" height="6" rx="1"/>
            <rect x="3" y="10" width="18" height="4" rx="1"/>
            <rect x="3" y="15" width="18" height="6" rx="1"/>
          </svg>
        </div>
        <h3>Multi-Channel</h3>
        <p>Vertically stacked channels</p>
      </div>
    </div>
  </div>
  }

  <!-- STEP 3: Upload and View (ECG/EEG) -->
  @if (step === 3 && (signalType === 'ecg' || signalType === 'eeg')) {
  <div>
    <button class="back-btn" (click)="goBack()">&#8592; Back to Mode Selection</button>

    <div class="text-center mb-4">
      <h2 class="main-title">{{ signalType.toUpperCase() }} Signal Viewer</h2>
      <p class="subtitle">{{ channelMode === 'single' ? 'Single Channel' : 'Multi-Channel' }} Display Mode</p>
    </div>

    <!-- File Upload -->
    <div class="control-panel">
      <div class="mb-3">
        <label class="control-label">Upload Signal File:</label>
        <input
          type="file"
          class="form-control file-input"
          (change)="onFileSelect($event)"
          accept=".json">
        <small class="text-muted">Select a converted JSON file from your ECG/EEG data</small>
      </div>
    </div>

    <!-- Controls shown after file load -->
    @if (channels.length > 0) {
    <div>
      <div class="channel-selection-panel">
        <h5 class="section-title">Select Channels to Display</h5>

        @if (channelMode === 'multi') {
        <div class="channel-grid">
          @for (channel of channels; track $index) {
          <label class="channel-checkbox-card">
            <input
              type="checkbox"
              class="channelBox"
              [checked]="selectedChannels[$index]"
              (change)="onChannelToggle($index)">
            <span>{{ channel }}</span>
          </label>
          }
        </div>
        }

        @if (channelMode === 'single') {
        <div class="text-center">
          <select class="channel-select" (change)="onSingleChannelChange($event)">
            <option value="" disabled selected>-- Select a Channel --</option>
            @for (channel of channels; track $index) {
            <option [value]="$index">{{ channel }}</option>
            }
          </select>
        </div>
        }
      </div>

      @if (hasSelectedChannels()) {
      <div class="playback-controls">
        <div class="button-container">
          <button class="btn-danger circle-btn" (click)="pause()" [disabled]="isPaused" title="Pause">&#9646;&#9646;</button>
          <button class="btn-success circle-btn" (click)="resume()" [disabled]="!isPaused" title="Resume">&#9654;</button>
        </div>
        <div class="time-control">
          <label class="control-label">Time Window</label>
          <div class="slider-container">
            <input
              type="range"
              class="time-slider"
              [min]="1"
              [max]="getMaxTimeWindow()"
              [step]="0.1"
              [value]="timeWindowSeconds"
              (input)="onTimeWindowChange($event)">
            <span class="time-value">{{ timeWindowSeconds.toFixed(1) }}s</span>
          </div>
        </div>
      </div>
      }
    </div>
    }

    <div class="graph-container">
      @if (channels.length === 0) {
      <div class="empty-state">
        <p style="font-size:1.5rem;font-weight:600;">No Signal Loaded</p>
        <p class="text-muted">Upload a JSON file to begin analysis</p>
      </div>
      }
      @if (channels.length > 0 && !hasSelectedChannels()) {
      <div class="empty-state">
        <p style="font-size:1.5rem;font-weight:600;">Signal Loaded Successfully</p>
        <p class="text-muted">Select channels above to display waveforms</p>
      </div>
      }
      <div id="signal-graph" class="signal-graph"></div>
    </div>
  </div>
  }

  <!-- STEP 2: Doppler Component -->
  @if (step === 2 && signalType === 'doppler') {
  <div>
    <button class="back-btn" (click)="goBack()">&#8592; Back</button>
    <app-doppler></app-doppler>
  </div>
  }

    <!-- STEP 2: Doppler Component -->
  @if (step === 2 && signalType === 'microbiome') {
  <div>
    <button class="back-btn" (click)="goBack()">&#8592; Back</button>
    <app-microbiome></app-microbiome>
  </div>
  }

      <!-- STEP 2: Doppler Component -->
  @if (step === 2 && signalType === 'drone') {
  <div>
    <button class="back-btn" (click)="goBack()">&#8592; Back</button>
    <app-drone-detector></app-drone-detector>
  </div>
  }

</div>